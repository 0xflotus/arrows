<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="lib/d3.js"></script>
<title>Arrow Tool</title>
</head>
<body>  

<h1>Arrow Tool</h1>
<button id="button-newnode">Create Node</button>
<button id="button-newrelationship">Create Relationship</button>

<div id="canvas"></div>

<script type="text/javascript">

// A maximum of 2 objects can be selected at any time
var selectedObjects = [];

var relationships = [];

var svg = d3.select("#canvas")
    .append("svg:svg")
    .attr("width", 1024)
    .attr("height", 768);

svg.append("svg:defs").append("svg:marker")
    .attr("id", "arrowhead")
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", 10)
    .attr("refY", 0)
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .attr("orient", "auto")
  .append("svg:path")
    .attr("d", "M0,-5 L10,0 L0,5");
        
var createNode = function() {
  var node = svg.append("svg:circle")
      .attr("cx", 50)
      .attr("cy", 140)
      .attr("r", 40)
      .attr("fill", "blue")
      .call(d3.behavior.drag().on("drag", move));
      
  node.on("click", function() {
    selectedObjects.push(node);
    if (selectedObjects.length > 2) {
      selectedObjects.shift();
    }
    console.log(selectedObjects);
  })
}

var pathForRelationship = function(relationship) {
  var path = {
    x1: Number(relationship.start.attr("cx")),
    y1: Number(relationship.start.attr("cy")),
    x2: Number(relationship.end.attr("cx")),
    y2: Number(relationship.end.attr("cy")),
  };
  var dx = path.x2 - path.x1;
  var dy = path.y2 - path.y1;
  var totalPathLength = Math.sqrt(dx * dx + dy * dy);
  var radiusFraction = 40 / totalPathLength;
  var ex = dx * radiusFraction;
  var ey = dy * radiusFraction;
  
  return "M" + (path.x1 + ex) + " " + (path.y1 + ey) + "L" + (path.x2 - ex) + " " + (path.y2 - ey);
}

var relationshipAngle = function(relationship) {
  var path = {
    x1: Number(relationship.start.attr("cx")),
    y1: Number(relationship.start.attr("cy")),
    x2: Number(relationship.end.attr("cx")),
    y2: Number(relationship.end.attr("cy")),
  };
  var dx = path.x2 - path.x1;
  var dy = path.y2 - path.y1;
  return Math.atan2(dy, dx) * 180 / Math.PI;
}

var startPosition = function(relationship) {
  return {
    x: Number(relationship.start.attr("cx")),
    y: Number(relationship.start.attr("cy"))
  }
}

var rotateAndTranslate = function(angleFunction, positionFunction) {
  return function(d) {
    var p = positionFunction(d);
    return "translate(" + p.x + "," + p.y +"), rotate(" + angleFunction(d) + ")";
  }
}

var drawRelationships = function() {
  var arrows = svg.selectAll(".arrow").data(relationships);
  
  arrows.enter()
    .append("svg:path")
    .attr("id", "relationship0")
    .attr("class", "arrow")
    .attr("d", pathForRelationship)
    .style("stroke", "black")
    .style("stroke-width", 2)
    .attr("marker-end", "url(#arrowhead)");
    
  arrows.transition()
    .attr("d", pathForRelationship)
    
  var relationshipTypes = svg.selectAll(".relationshipType").data(relationships);
  
  relationshipTypes.enter()
    .append("svg:g")
    .attr("class", "relationshipType")
    .attr("transform", rotateAndTranslate(relationshipAngle, startPosition))
    .append("svg:text")
    .attr("x", 43)
    .attr("y", -3)
    .text(function(relationship) { return relationship.type; });

  relationshipTypes.transition()
    .attr("transform", rotateAndTranslate(relationshipAngle, startPosition));
}

var createRelationship = function() {
  if (selectedObjects.length == 2) {
    relationships.push({ 
      type: "KNOWS", 
      start: selectedObjects[0], 
      end: selectedObjects[1]
    });
  }
  drawRelationships();
}



createNode();
d3.select("#button-newnode").on("click", createNode);
d3.select("#button-newrelationship").on("click", createRelationship);
    
    
function move(){
    var dragTarget = d3.select(this);
    dragTarget
        .attr("cx", function(){return d3.event.dx + parseInt(dragTarget.attr("cx"))})
        .attr("cy", function(){return d3.event.dy + parseInt(dragTarget.attr("cy"))});
     drawRelationships();   
};

</script>
   
</body>
</html>