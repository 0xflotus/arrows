<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="lib/d3.js"></script>
  <script type="text/javascript" src="graph-diagram.js"></script>
  <link rel="stylesheet" href="graph-diagram.css" type="text/css">
  <title>Arrow Tool</title>
</head>
<body>  

<h1>Arrow Tool</h1>
<p>
  <a id="exportlink" target="_blank">Export SVG</a>
</p>

<div id="canvas"></div>

<script type="text/javascript">

var graphModel = {
  nodes: {
    0: { id: 0, x: 50, y: 140 }
  },
  relationships: [],
  internalScale: 1,
  externalScale: 1
};

var svg = d3.select("#canvas")
  .append("svg:svg")
  .attr("width", 1024)
  .attr("height", 768);

function draw()
{
  bind(graphModel, svg.data([graphModel]));
  svg.selectAll(".graph-diagram-node")
    .call(d3.behavior.drag().on("drag", drag ).on("dragend", dragEnd));
}

var createNode = function ( x, y ) {
  var nodeId = d3.values(graphModel.nodes ).length;
  var node = { id: nodeId, x: x, y: y };
  graphModel.nodes[nodeId] = node;
  return node;
}

var createRelationship = function(start, end) {
  var relationship = {
    label: "KNOWS",
    start: start,
    end: end
  };
  graphModel.relationships.push(relationship);
  return relationship;
}

var exportSvg = function() {
  d3.select("#exportlink")
    .attr("href", "data:image/svg+xml;base64," + 
      btoa("<svg xmlns=\"http://www.w3.org/2000/svg\"" +
        document.getElementById("canvas").innerHTML.substring(4)));
}

draw();

d3.select("#button-newrelationship").on("click", createRelationship);
d3.select("#exportlink").on("click", exportSvg);
    
var newNode = null;
var newRelationship = null;

function findClosestOverlappingNode(node) {

  function cx(d) {
    return d.x * graphModel.internalScale;
  }
  function cy(d) {
    return d.y * graphModel.internalScale;
  }

  function centre(node) {
    return {
      x: cx(node),
      y: cy(node)
    };
  }

  function distance(startPoint, endPoint) {
    var dx = endPoint.x - startPoint.x;
    var dy = endPoint.y - startPoint.y;
    return Math.sqrt(dx * dx + dy * dy);
  }

  var closestNode = null;
  var closestDistance = Number.MAX_VALUE;

  var allNodes = d3.values(graphModel.nodes);

  for (i = 0; i < allNodes.length; i++) {
    var candidateNode = allNodes[i];
    if (candidateNode !== node) {
      var candidateDistance = distance(centre(node), centre(candidateNode));
      if (candidateDistance < 50 && candidateDistance < closestDistance) {
        closestNode = candidateNode;
        closestDistance = candidateDistance;
      }
    }
  }
  return closestNode;
}

function drag(){
  var shiftKey = window.event.shiftKey;
  var dragTarget = d3.select(this);
  var node = dragTarget[0][0].__data__;
  if (!newNode & shiftKey) {
    newNode = createNode(node.x, node.y);
    newRelationship = createRelationship(node, newNode);
  }
  if (newNode) {
    var connectionNode = findClosestOverlappingNode(newNode);
    if (connectionNode) {
      newRelationship.end = connectionNode
    } else {
      newRelationship.end = newNode;
    }
    node = newNode;
  }
  node.x += d3.event.dx;
  node.y += d3.event.dy;
  draw();
}

function dragEnd() {
  if (newNode && newRelationship && newRelationship.end !== newNode) {
    delete graphModel.nodes[newNode.id];
  }
  newNode = null;
  draw();
}

</script>
   
</body>
</html>