<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="lib/d3.js"></script>
  <script type="text/javascript" src="graph-diagram.js"></script>
  <link rel="stylesheet" href="graph-diagram.css" type="text/css">
  <title>Arrow Tool</title>
</head>
<body>  

<h1>Arrow Tool</h1>
<p>
  <a id="exportlink" target="_blank">Export SVG</a>
</p>
<button id="button-newnode">Create Node</button>
<button id="button-newrelationship">Create Relationship</button>

<div id="canvas"></div>

<script type="text/javascript">

var radius = 40;

// A maximum of 2 objects can be selected at any time
var selectedObjects = [];

var graphModel = {
  nodes: {
    0: { id: 0, x: 50, y: 140 }
  },
  relationships: [],
  internalScale: 1,
  externalScale: 1
};

var svg = d3.select("#canvas")
  .append("svg:svg")
  .attr("width", 1024)
  .attr("height", 768);

function draw()
{
  bind(graphModel, svg.data([graphModel]));
  svg.selectAll(".graph-diagram-node")
    .call(d3.behavior.drag().on("drag", move));
}

var createNode = function() {
  var nodeId = d3.values(graphModel.nodes ).length;
  graphModel.nodes[nodeId] = { id: nodeId, x: 100, y: 240 };
  draw();
}

var drawRelationships = function() {
  var connections = svg.selectAll(".arrow").data(relationships);
  
  connections.enter()
    .append("svg:g")
    .attr("class", "arrow")
    .attr("transform", rotateAndTranslate(relationshipAngle, startPosition))
    .call(addArrow)
    .call(addLabel);
    
  connections.transition()
    .attr("transform", rotateAndTranslate(relationshipAngle, startPosition))
    .select("path")
    .attr("d", pathForRelationship);
}

var createRelationship = function() {
  if (selectedObjects.length == 2) {
    relationships.push({ 
      type: "KNOWS", 
      start: selectedObjects[0], 
      end: selectedObjects[1]
    });
  }
  drawRelationships();
}

var exportSvg = function() {
  d3.select("#exportlink")
    .attr("href", "data:image/svg+xml;base64," + 
      btoa("<svg xmlns=\"http://www.w3.org/2000/svg\"" +
        document.getElementById("canvas").innerHTML.substring(4)));
}

draw();

d3.select("#button-newnode").on("click", createNode);
d3.select("#button-newrelationship").on("click", createRelationship);
d3.select("#exportlink").on("click", exportSvg);
    
    
function move(){
  var dragTarget = d3.select(this);
  var node = dragTarget[0][0].__data__;
  node.x += d3.event.dx;
  node.y += d3.event.dy;
  draw();
};

</script>
   
</body>
</html>